---
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import CookieBanner from "../components/CookieBanner.astro";
import "../styles/global.css";
import PostHog from "../components/PostHog.astro";
import SEO from "../components/SEO.astro";
import LinkedInTag from "../components/LinkedInTag.astro";
import RB2B from "../components/RB2B.astro";

interface Props {
	title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<title>{title}</title>
		<SEO
			title={title}
			description="Tony Rosen - Marketing & Creative Project Manager. Specialized in product marketing, satellite communications, and creative team leadership."
		/>
		<link
			rel="icon"
			type="image/png"
			href="/favicon-dark.png"
			media="(prefers-color-scheme: dark)"
		/>
		<link
			rel="icon"
			type="image/png"
			href="/favicon-light.png"
			media="(prefers-color-scheme: light)"
		/>
		<meta name="generator" content={Astro.generator} />

		<!-- Preconnect to critical third-party origins -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="preconnect" href="https://cdn.jsdelivr.net" />

		<!-- DNS prefetch for analytics (loaded later via requestIdleCallback) -->
		<link rel="dns-prefetch" href="https://us.i.posthog.com" />
		<link rel="dns-prefetch" href="https://us-assets.i.posthog.com" />
		<link rel="dns-prefetch" href="https://www.googletagmanager.com" />
		<link rel="dns-prefetch" href="https://snap.licdn.com" />
		<link rel="dns-prefetch" href="https://ddwl4m2hdecbv.cloudfront.net" />

		<!-- Load fonts with display=swap and optional to avoid render blocking -->
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
			rel="stylesheet"
			media="print"
			onload="this.media='all'"
		/>
		<noscript>
			<link
				href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap"
				rel="stylesheet"
			/>
		</noscript>
		<!-- Preload critical JavaScript modules -->
		<link
			rel="modulepreload"
			href="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.es.js"
		/>

		<!-- Inline critical CSS for initial render to improve FCP -->
		<style>
			/* Critical above-the-fold styles */
			html {
				height: auto;
			}
			body {
				margin: 0;
				background-color: rgb(15 23 42); /* slate-900 */
				color: white;
				font-family: Inter, system-ui, -apple-system, sans-serif;
				transition: color 0.3s, background-color 0.3s;
			}
			/* Prevent layout shift */
			* {
				box-sizing: border-box;
			}
			/* Lenis critical styles - inlined to prevent FOUC */
			html.lenis,
			html.lenis body {
				height: auto;
			}
			.lenis.lenis-smooth {
				scroll-behavior: auto !important;
			}
			.lenis.lenis-stopped {
				overflow: hidden;
			}
		</style>

		<script is:inline>
			// Initialize Theme
			if (
				localStorage.getItem("theme") === "dark" ||
				(!("theme" in localStorage) &&
					window.matchMedia("(prefers-color-scheme: dark)").matches)
			) {
				document.documentElement.classList.add("dark");
			} else {
				document.documentElement.classList.remove("dark");
			}
		</script>
		<!-- Google tag (gtag.js) - Deferred for performance -->
		<script is:inline>
			// Defer Google Analytics to improve initial page load
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());
			gtag("config", "G-7LRLJTJG4L");

			// Load GA script after page is interactive
			function loadGA() {
				const script = document.createElement("script");
				script.src = "https://www.googletagmanager.com/gtag/js?id=G-7LRLJTJG4L";
				script.async = true;
				document.head.appendChild(script);
			}

			// Use requestIdleCallback to defer GA loading
			if ("requestIdleCallback" in window) {
				requestIdleCallback(loadGA, { timeout: 2000 });
			} else {
				setTimeout(loadGA, 2000);
			}
		</script>
		<PostHog />
		<LinkedInTag />
		<RB2B />
	</head>
	<body
		class="bg-slate-900 text-gray-900 transition-colors duration-300 selection:bg-blue-500 selection:text-white dark:text-white"
	>
		<Navbar />
		<slot />
		<Footer />
		<CookieBanner />
		<script>
			// Defer Lenis initialization to reduce TBT and improve LCP/FCP
			function initLenis() {
				import("lenis").then(({ default: Lenis }) => {
					const lenis = new Lenis();

					// Expose lenis globally for other components to use
					window.lenis = lenis;

					let lenisRafId: number | null = null;
					let hasUserInteracted = false;

					function raf(time: number) {
						lenis.raf(time);
						lenisRafId = requestAnimationFrame(raf);
					}

					function startLenisLoop() {
						if (lenisRafId === null) {
							lenisRafId = requestAnimationFrame(raf);
						}
					}

					function stopLenisLoop() {
						if (lenisRafId !== null) {
							cancelAnimationFrame(lenisRafId);
							lenisRafId = null;
						}
					}

					// Track user interaction
					["scroll", "click", "keydown", "touchstart", "mousemove"].forEach(
						(eventType) => {
							document.addEventListener(
								eventType,
								() => {
									hasUserInteracted = true;
									// Restart Lenis if it was stopped by idle timeout
									startLenisLoop();
								},
								{ passive: true, once: eventType === "scroll" }
							);
						}
					);

					// Start on load
					startLenisLoop();

					// IDLE TIMEOUT: Stop Lenis after 5 seconds if no user interaction
					// This helps Lighthouse complete its analysis
					const IDLE_TIMEOUT = 5000;
					setTimeout(() => {
						if (!hasUserInteracted) {
							stopLenisLoop();
						}
					}, IDLE_TIMEOUT);

					// Pause Lenis when tab is hidden to save CPU
					document.addEventListener("visibilitychange", () => {
						if (document.hidden) {
							stopLenisLoop();
						} else if (hasUserInteracted) {
							startLenisLoop();
						}
					});
				});
			}

			// Delay Lenis even more aggressively - wait for page load event
			// This moves it completely off the critical rendering path
			if (document.readyState === "complete") {
				// Page already loaded
				if ("requestIdleCallback" in window) {
					requestIdleCallback(initLenis, { timeout: 3000 });
				} else {
					setTimeout(initLenis, 1000);
				}
			} else {
				// Wait for load event
				window.addEventListener("load", () => {
					if ("requestIdleCallback" in window) {
						requestIdleCallback(initLenis, { timeout: 3000 });
					} else {
						setTimeout(initLenis, 1000);
					}
				});
			}
		</script>
	</body>
</html>
